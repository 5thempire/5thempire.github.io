<!DOCTYPE html>
<html lang="en-US">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="An experiment in tech">
<meta name="keywords" content="python,pyspark,docker">

<base href="https://5thempire.pt">

<title>
  5th Empire - Amazon DynamoDB 
</title>

<meta name="generator" content="Hugo 0.61.0" />



<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400|Roboto+Slab:400,700|Roboto:300,300i,400,400i,500,500i,700,700i">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
<link rel="stylesheet" href="https://5thempire.pt/css/main.css">
<link rel="stylesheet" href="https://5thempire.pt/css/custom.css">




<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

<meta property="og:title" content="Amazon DynamoDB" />
<meta property="og:description" content="A python approach on Amazon DynamoDB" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://5thempire.pt/code/aws-dynamo/" />
<meta property="og:image" content="https://5thempire.pt/fifth.png"/>
<meta property="og:site_name" content="5th Empire" />


</head>
<body lang="en-US">
<div class="container">


<header class="row text-left title">
  <img src="/img/Amazon%20DynamoDB.png">
  <h1 class="title">Amazon DynamoDB</h1>
</header>
<section id="category-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-left meta">
       
      
    </h6>
  </div>
  
</section>
<section id="content-pane" class="row">
  <div class="col-md-12 text-justify content">
    
    <p>Python approach on how to interact with Amazon DynamoDB. Check <a href="https://github.com/5thempire/aws-dynamodb">https://github.com/5thempire/aws-dynamodb</a> for the complete source code. The requirements are:</p>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html">boto3</a></li>
<li><a href="https://hub.docker.com/r/amazon/dynamodb-local/">DynamoDB docker</a></li>
<li><a href="https://www.python.org/">Python</a></li>
</ul>
<h2 id="data-model-definition">Data model Definition</h2>
<p>In these examples two different data models are used, their choice is
meant to illustrate what can be achieved and how it can be operated.</p>
<ul>
<li><strong>Key-Value data model</strong> for domains</li>
<li><strong>Document data model</strong> for logs</li>
</ul>
<p>It's advisable that you look at <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html"><strong>ProvisionedThroughput</strong></a>. It should be properly set, since it depends on the amounts of reads and writes your application performs to DynamoDB.</p>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html"><strong>Attribute definitions</strong></a> defines the core of the table.</p>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GSI.html"><strong>Global secondary indexes</strong></a> are used to speed up queries on non-key attributes. In a DynamoDB table, each key value must be unique. However, the key values in a global secondary index do not need to be unique.</p>
<p>It contains a selection of attributes from the base table, but they are organized by a primary key that is different from that of the table. The index key does not need to have any of the key attributes from the table. It doesn't even need to have the same key schema as a table.</p>
<ul>
<li>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Projection.html"><strong>ProjectionType</strong></a> defines a set of attributes that are projected into the index. This definition is important when storing documents, since it defines what we retrieve when querying.</p>
<ul>
<li>KEYS_ONLY - Only the index and primary keys are projected into the index.</li>
<li>INCLUDE - Only the specified table attributes are projected into the index. The list of projected attributes is in NonKeyAttributes.</li>
<li>ALL - All of the table attributes are projected into the index.</li>
</ul>
</li>
</ul>
<h3 id="key-value-data-model">Key-Value data model</h3>
<p>In this schema url is the hash key, therefore it's the only element that identifies
the item and the only that can be searched for.</p>
<p>The domain item we're storing has two attributes, the url and the corresponding domain.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">TABLE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Domain</span><span style="color:#e6db74">&#39;</span>
DOMAIN <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">domain</span><span style="color:#e6db74">&#39;</span>
URL <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">url</span><span style="color:#e6db74">&#39;</span>
SCHEMA <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeDefinitions</span><span style="color:#e6db74">&#39;</span>: [
        {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeName</span><span style="color:#e6db74">&#39;</span>: URL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>
        }
    ],
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">KeySchema</span><span style="color:#e6db74">&#39;</span>: [
        {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeName</span><span style="color:#e6db74">&#39;</span>: URL,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">KeyType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">HASH</span><span style="color:#e6db74">&#39;</span>
        }
    ],
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ProvisionedThroughput</span><span style="color:#e6db74">&#39;</span>: {
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ReadCapacityUnits</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">10</span>,
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">WriteCapacityUnits</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">10</span>
    }
}
</code></pre></div><h3 id="document-data-model">Document data model</h3>
<p>This model has two hashes or indexes, the timestamp and the status. Besides these attributes we're going to store the log message. Since we want to query both, a global secondary index is set. It's worth mentioning that we could store more attributes than just these, but for the demonstration it's enough.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">TABLE_NAME <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Log</span><span style="color:#e6db74">&#39;</span>
TIMESTAMP <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">updated_at</span><span style="color:#e6db74">&#39;</span>
STATUS <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">status</span><span style="color:#e6db74">&#39;</span>
INDEX_STATUS_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Status</span><span style="color:#e6db74">&#39;</span>
SCHEMA <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeDefinitions</span><span style="color:#e6db74">&#39;</span>: [
        {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeName</span><span style="color:#e6db74">&#39;</span>: TIMESTAMP,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>
        },
        {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeName</span><span style="color:#e6db74">&#39;</span>: STATUS,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>
        }
        ],
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">KeySchema</span><span style="color:#e6db74">&#39;</span>: [
        {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeName</span><span style="color:#e6db74">&#39;</span>: TIMESTAMP,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">KeyType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">HASH</span><span style="color:#e6db74">&#39;</span>
        }
    ],
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ProvisionedThroughput</span><span style="color:#e6db74">&#39;</span>: {
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ReadCapacityUnits</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">10</span>,
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">WriteCapacityUnits</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">10</span>
    },
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">GlobalSecondaryIndexes</span><span style="color:#e6db74">&#39;</span>: [{
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">IndexName</span><span style="color:#e6db74">&#39;</span>: INDEX_STATUS_KEY,
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">KeySchema</span><span style="color:#e6db74">&#39;</span>: [{
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">AttributeName</span><span style="color:#e6db74">&#39;</span>: STATUS,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">KeyType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">HASH</span><span style="color:#e6db74">&#39;</span>
        }
        ],
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Projection</span><span style="color:#e6db74">&#39;</span>: {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ProjectionType</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ALL</span><span style="color:#e6db74">&#39;</span>
        },
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ProvisionedThroughput</span><span style="color:#e6db74">&#39;</span>: {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ReadCapacityUnits</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">10</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">WriteCapacityUnits</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">10</span>
        }
    }],
}
</code></pre></div><h2 id="python-classes">Python classes</h2>
<h3 id="dynamo-base-class">Dynamo base class</h3>
<p>This approach has one base class to interact with dynamo, which is not meant to be used on it's own, but to provide a solid base for the table specific definitons.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> abstractmethod

<span style="color:#f92672">import</span> boto3


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamoBase</span>:

    <span style="color:#66d9ef">def</span> __init__(self, conf):
        self<span style="color:#f92672">.</span>conf <span style="color:#f92672">=</span> conf

        <span style="color:#66d9ef">try</span>:
            self<span style="color:#f92672">.</span>dynamodb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>client(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dynamodb</span><span style="color:#e6db74">&#39;</span>, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>conf)
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> err:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{} - {}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(__name__, err))
            sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">1</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_table</span>(self, table_schema, table_name):
        self<span style="color:#f92672">.</span>table_name <span style="color:#f92672">=</span> table_name
        <span style="color:#66d9ef">try</span>:
            self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>create_table(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>table_schema)
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> err:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{} - already exists - {}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(table_name, err))
        <span style="color:#66d9ef">finally</span>:
            <span style="color:#75715e"># Wait for the table to exist before exiting</span>
            waiter <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>get_waiter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">table_exists</span><span style="color:#e6db74">&#39;</span>)
            waiter<span style="color:#f92672">.</span>wait(TableName<span style="color:#f92672">=</span>table_name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_table</span>(self, table_name):
        dyndb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dynamodb</span><span style="color:#e6db74">&#39;</span>, <span style="color:#f92672">*</span><span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>conf)
        <span style="color:#66d9ef">return</span> dyndb<span style="color:#f92672">.</span>Table(table_name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_all</span>(self):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        For TESTING puposes ONLY, should not be used in</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        production</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>scan(TableName<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>table_name)

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_params</span>(self, key):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">put_params</span>(self, key, data):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_params</span>(self, key, data):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#a6e22e">@abstractmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_params</span>(self, key, data):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, key):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Get from DynamoDB</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        params <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_params(key)
        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>get_item(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>params)
        <span style="color:#66d9ef">return</span> response

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">put</span>(self, key, data):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Write to DynamoDB</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        params <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>put_params(key, data)
        self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>put_item(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>params)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, key, data):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Update to DynamoDB</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        params <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>update_params(key, data)
        self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>update_item(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>params)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exists</span>(self, key):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Returns a boolean depending</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        on the existence of the key</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get(key)
        <span style="color:#66d9ef">return</span> True <span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Item</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">in</span> data <span style="color:#66d9ef">else</span> False

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove</span>(self, key):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Removes a key</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        params <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>remove_params(key)
        self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>delete_item(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>params)
</code></pre></div><h3 id="dynamo-domain-class">Dynamo domain class</h3>
<p>This class overrides the base class by defining what's particular for the domain data model interaction.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> dynamo.base <span style="color:#f92672">import</span> DynamoBase
<span style="color:#f92672">from</span> samples.domain.schema <span style="color:#f92672">import</span> TABLE_NAME, DOMAIN, URL


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamoDomain</span>(DynamoBase):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_params</span>(self, key):
        params <span style="color:#f92672">=</span> {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Key</span><span style="color:#e6db74">&#39;</span>: {
                URL: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: key}
            }
        }
        <span style="color:#66d9ef">return</span> params

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">put_params</span>(self, key, data):
        params <span style="color:#f92672">=</span> {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Item</span><span style="color:#e6db74">&#39;</span>: {
                URL: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: key},
            }
        }
        params[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Item</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>update(data)
        <span style="color:#66d9ef">return</span> params

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_params</span>(self, key):
        params <span style="color:#f92672">=</span> {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Key</span><span style="color:#e6db74">&#39;</span>: {
                URL: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: key}
            }
        }
        <span style="color:#66d9ef">return</span> params

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_value</span>(self, key, value):
        params <span style="color:#f92672">=</span> {
            DOMAIN: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>: value}
        }
        self<span style="color:#f92672">.</span>put(key, params)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_domain</span>(self, key):
        data <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get(key)
        <span style="color:#66d9ef">return</span> data[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Item</span><span style="color:#e6db74">&#39;</span>][URL][<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>]
</code></pre></div><h3 id="dynamo-log-class">Dynamo log class</h3>
<p>This class overrides the base class by defining what's particular for the log data model interaction.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> dynamo.base <span style="color:#f92672">import</span> DynamoBase
<span style="color:#f92672">from</span> samples.log.schema <span style="color:#f92672">import</span> TABLE_NAME, TIMESTAMP, STATUS, INDEX_STATUS_KEY


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamoLog</span>(DynamoBase):

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_params</span>(self, key):
        params <span style="color:#f92672">=</span> {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Key</span><span style="color:#e6db74">&#39;</span>: {
                TIMESTAMP: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: key}
            }
        }
        <span style="color:#66d9ef">return</span> params

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">put_params</span>(self, key, data):
        params <span style="color:#f92672">=</span> {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Item</span><span style="color:#e6db74">&#39;</span>: {
                TIMESTAMP: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: key},
            }
        }
        params[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Item</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>update(data)
        <span style="color:#66d9ef">return</span> params

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_params</span>(self, timestamp, value):
        params <span style="color:#f92672">=</span> {
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ExpressionAttributeNames</span><span style="color:#e6db74">&#39;</span>: {
                <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">#LU</span><span style="color:#e6db74">&#39;</span>: INDEX_STATUS_KEY,
                <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">#S</span><span style="color:#e6db74">&#39;</span>: STATUS
            },
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ExpressionAttributeValues</span><span style="color:#e6db74">&#39;</span>: {
                <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">:lu</span><span style="color:#e6db74">&#39;</span>: {
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>: timestamp
                },
                <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">:s</span><span style="color:#e6db74">&#39;</span>: {
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#39;</span>: value
                }
            },
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Key</span><span style="color:#e6db74">&#39;</span>: {
                TIMESTAMP: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: timestamp}
            },
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ReturnValues</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">UPDATED_NEW</span><span style="color:#e6db74">&#39;</span>,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">TableName</span><span style="color:#e6db74">&#39;</span>: TABLE_NAME,
            <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">UpdateExpression</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">SET #LU = :lu, #S = :s</span><span style="color:#e6db74">&#39;</span>
        }
        <span style="color:#66d9ef">return</span> params

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">filter_by_timestamp_status</span>(self, timestamp, status):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Filters all entries by timestamp and status</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>query(TableName<span style="color:#f92672">=</span>TABLE_NAME,
                                       KeyConditionExpression<span style="color:#f92672">=</span>f<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{TIMESTAMP} = :updated_at</span><span style="color:#e6db74">&#34;</span>,
                                       FilterExpression<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#S = :status</span><span style="color:#e6db74">&#34;</span>,
                                       ExpressionAttributeValues<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">:status</span><span style="color:#e6db74">&#34;</span>: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: status},
                                                                  <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">:updated_at</span><span style="color:#e6db74">&#34;</span>: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: timestamp}},
                                       ExpressionAttributeNames<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#S</span><span style="color:#e6db74">&#34;</span>: STATUS})
        <span style="color:#66d9ef">return</span> response

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">filter_by_status</span>(self, status):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Filters all entries by key two</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        response <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>query(TableName<span style="color:#f92672">=</span>TABLE_NAME,
                                       IndexName<span style="color:#f92672">=</span>INDEX_STATUS_KEY,
                                       KeyConditionExpression<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#S = :status</span><span style="color:#e6db74">&#34;</span>,
                                       ExpressionAttributeValues<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">:status</span><span style="color:#e6db74">&#34;</span>: {<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">S</span><span style="color:#e6db74">&#34;</span>: status}},
                                       ExpressionAttributeNames<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#S</span><span style="color:#e6db74">&#34;</span>: STATUS})
        <span style="color:#66d9ef">return</span> response

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, timestamp, status):
        <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        Update to DynamoDB</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">        </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
        params <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>update_params(timestamp, status)

        self<span style="color:#f92672">.</span>dynamodb<span style="color:#f92672">.</span>update_item(<span style="color:#f92672">*</span><span style="color:#f92672">*</span>params)
</code></pre></div><h2 id="amazon-dynamodb-docker">Amazon DynamoDB Docker</h2>
<p>To test the implementation use the Amazon DynamoDB docker image.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -p 8000:8000 amazon/dynamodb-local
</code></pre></div><p>Set Amazon DynamoDB configuration as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">aws_conf <span style="color:#f92672">=</span> {
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">aws_access_key_id</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dummy_key</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">aws_secret_access_key</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dummy_secret</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">region_name</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dummy_region</span><span style="color:#e6db74">&#39;</span>,
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">endpoint_url</span><span style="color:#e6db74">&#39;</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">http://localhost:8000</span><span style="color:#e6db74">&#39;</span>
    }
</code></pre></div>
  </div>
</section>
<section id="tag-pane" class="row meta">
  
  <div class="col-md-12">
    <h6 class="text-right meta">
      
    </h6>
  </div>
  
</section>








<section id="menu-pane" class="row menu text-center">
  
  
  <span><a class="menu-item" href="https://5thempire.pt/code/pyspark/">&lt; prev | </a></span>
  
  
  <span><a class="menu-item" href="/code">code</a></span>
  
  
  
  <h4 class="text-center"><a class="menu-item" href="https://5thempire.pt">home</a></h4>
</section>



</div>
<footer class="row text-center footer">
  <hr />
  
  <h6 class="text-center copyright">Â© 2019. 5thEmpire. <a href="http://creativecommons.org/licenses/by/3.0/">Some Rights Reserved</a>.</h6>
  
  <h6 class="text-center powered">Powered by <a href="https://gohugo.io/">Hugo  v0.61.0</a> &amp; <a href="https://github.com/shenoybr/hugo-goa">Goa</a>.</h6>
  
      
      <h6><a href="" aria-label="RSS Feed"><i class="fas fa-rss" aria-hidden="true"></i></a></h6>
    
  
</footer>







<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-154354893-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="js/main.js"></script>
<script src="js/custom.js"></script>
</body>
</html>


